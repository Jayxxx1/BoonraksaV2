// server/prisma/schema.prisma

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

// --------------------------------------------------------
// üë• ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User Management) - 8 Roles
// --------------------------------------------------------

enum Role {
    ADMIN // ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Super Admin)
    EXECUTIVE // ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (‡∏î‡∏π Dashboard)
    SALES // ‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢
    GRAPHIC // ‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å (‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö/‡∏ó‡∏≥‡πÑ‡∏ü‡∏•‡πå)
    STOCK // ‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á/‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á)
    PRODUCTION // ‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï (‡∏õ‡∏±‡∏Å/‡∏™‡∏Å‡∏£‡∏µ‡∏ô)
    SEWING_QC // ‡∏ù‡πà‡∏≤‡∏¢‡∏ï‡∏±‡∏î‡πÄ‡∏¢‡πá‡∏ö‡πÅ‡∏•‡∏∞ QC
    DELIVERY // ‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
}

model User {
    id       Int     @id @default(autoincrement())
    username String  @unique
    password String
    name     String
    role     Role    @default(SALES)
    isActive Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    openedOrders  Order[] @relation("SalesOrders")
    graphicOrders Order[] @relation("GraphicOrders")
    qcOrders      Order[] @relation("QCOrders")

    activityLogs ActivityLog[]
    pushSubs     PushSubscription[]
}

// --------------------------------------------------------
// üõçÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Product Management)
// --------------------------------------------------------

model Category {
    id       Int       @id @default(autoincrement())
    name     String
    products Product[]
}

model Product {
    id          Int     @id @default(autoincrement())
    name        String
    codePrefix  String? // ‡πÄ‡∏ä‡πà‡∏ô "A", "P"
    description String?
    imageUrl    String? // Link ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å S3

    categoryId Int
    category   Category @relation(fields: [categoryId], references: [id])

    variants ProductVariant[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

enum Gender {
    male
    female
    unisex
}

model ProductVariant {
    id     Int    @id @default(autoincrement())
    sku    String @unique // ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô "A101-M"
    code   String // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ/‡πÅ‡∏ö‡∏ö
    color  String
    size   String
    gender Gender @default(unisex)

    price Decimal @db.Decimal(10, 2)
    cost  Decimal @default(0) @db.Decimal(10, 2)

    stock    Int     @default(0)
    minStock Int     @default(5) // ‡∏à‡∏∏‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    location String? // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á

    productId Int
    product   Product @relation(fields: [productId], references: [id])

    orderItems OrderItem[]
}

// --------------------------------------------------------
// üì¶ ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Order System)
// --------------------------------------------------------

enum OrderStatus {
    PENDING // ‡∏£‡∏≠‡πÄ‡∏á‡∏¥‡∏ô
    CONFIRMED // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô/‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    DESIGNING // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö
    PRODUCTION // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï
    PACKING // ‡πÅ‡∏û‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á
    DELIVERY // ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
    COMPLETED // ‡∏à‡∏ö‡∏á‡∏≤‡∏ô
    CANCELLED // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
}

model Order {
    id    Int    @id @default(autoincrement())
    jobId String @unique // JOB-6701-001

    customerName    String
    customerPhone   String?
    customerAddress String?

    totalPrice Decimal     @db.Decimal(10, 2)
    deposit    Decimal     @default(0) @db.Decimal(10, 2)
    status     OrderStatus @default(PENDING)
    dueDate    DateTime?

    // ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
    salesId Int
    sales   User @relation("SalesOrders", fields: [salesId], references: [id])

    graphicId Int?
    graphic   User? @relation("GraphicOrders", fields: [graphicId], references: [id])

    qcId Int?
    qc   User? @relation("QCOrders", fields: [qcId], references: [id])

    items OrderItem[]
    logs  ActivityLog[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model OrderItem {
    id      Int   @id @default(autoincrement())
    orderId Int
    order   Order @relation(fields: [orderId], references: [id])

    // ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
    variantId Int
    variant   ProductVariant @relation(fields: [variantId], references: [id])

    productName String // Snapshot ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠
    price       Decimal @db.Decimal(10, 2)
    quantity    Int
    details     Json? // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏Å‡∏£‡∏µ‡∏ô/‡∏õ‡∏±‡∏Å
}

// --------------------------------------------------------
// üìä ‡∏™‡πà‡∏ß‡∏ô Log ‡πÅ‡∏•‡∏∞ Notification
// --------------------------------------------------------

model ActivityLog {
    id        Int      @id @default(autoincrement())
    action    String
    details   String?
    orderId   Int?
    order     Order?   @relation(fields: [orderId], references: [id])
    userId    Int
    user      User     @relation(fields: [userId], references: [id])
    timestamp DateTime @default(now())
}

model PushSubscription {
    id        Int      @id @default(autoincrement())
    endpoint  String
    keys      Json
    userId    Int
    user      User     @relation(fields: [userId], references: [id])
    createdAt DateTime @default(now())
}
