// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN // ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Super Admin)
  EXECUTIVE // ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (‡∏î‡∏π Dashboard)
  SALES // ‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢
  GRAPHIC // ‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å (‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö/‡∏ó‡∏≥‡πÑ‡∏ü‡∏•‡πå)
  STOCK // ‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á/‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á)
  PRODUCTION // ‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï (‡∏õ‡∏±‡∏Å/‡∏™‡∏Å‡∏£‡∏µ‡∏ô)
  SEWING_QC // ‡∏ù‡πà‡∏≤‡∏¢‡∏ï‡∏±‡∏î‡πÄ‡∏¢‡πá‡∏ö‡πÅ‡∏•‡∏∞ QC
  DELIVERY // ‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
  PURCHASING // ‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (NEW)
  MARKETING  // ‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î (NEW)
  FINANCE    // ‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (NEW)
}

model User {
  id          Int     @id @default(autoincrement())
  salesNumber String?
  username    String  @unique
  password    String
  name        String
  role        Role    @default(SALES)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  openedOrders  Order[] @relation("SalesOrders")
  graphicOrders Order[] @relation("GraphicOrders")
  qcOrders      Order[] @relation("QCOrders")
  stockOrders   Order[] @relation("StockOrders")
  productionIdOrders Order[] @relation("ProductionOrders")

  activityLogs ActivityLog[]
  pushSubs     PushSubscription[]
  uploadedPaymentSlips PaymentSlip[]
}

// --------------------------------------------------------
// üõçÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Product Management)
// --------------------------------------------------------

model Category {
  id       Int       @id @default(autoincrement())
  name     String
  products Product[]
}

model Product {
  id          Int     @id @default(autoincrement())
  name        String
  codePrefix  String? // ‡πÄ‡∏ä‡πà‡∏ô "A", "P"
  description String?
  imageUrl    String? // Link ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å S3

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  variants ProductVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Gender {
  male
  female
  unisex
}

model ProductVariant {
  id     Int    @id @default(autoincrement())
  sku    String @unique // ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô "A101-M"
  code   String // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ/‡πÅ‡∏ö‡∏ö
  color  String
  size   String
  gender Gender @default(unisex)

  price Decimal @db.Decimal(10, 2)
  cost  Decimal @default(0) @db.Decimal(10, 2)

  stock    Int     @default(0)
  minStock Int     @default(5) // ‡∏à‡∏∏‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  location String? // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  orderItems       OrderItem[]
  purchaseRequests PurchaseRequest[]
}

// --------------------------------------------------------
// üì¶ ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Order System)
// --------------------------------------------------------

enum OrderStatus {
  PENDING_ARTWORK      // ‡∏£‡∏≠‡∏ß‡∏≤‡∏á‡πÅ‡∏ö‡∏ö
  DESIGNING            // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡πÅ‡∏ö‡∏ö
  PENDING_PAYMENT      // ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  PENDING_STOCK_CHECK  // ‡∏£‡∏≠‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÄ‡∏ä‡πá‡∏Ñ
  STOCK_ISSUE          // ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
  IN_PRODUCTION        // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï
  PRODUCTION_FINISHED  // ‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏£‡∏≠ QC)
  QC_PASSED            // ‡∏ú‡πà‡∏≤‡∏ô QC (‡∏£‡∏≠‡πÅ‡∏û‡πá‡∏Ñ)
  READY_TO_SHIP        // ‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
  COMPLETED            // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
  CANCELLED            // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
}

enum BlockType {
  OLD // 1. ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏°
  EDIT // 2. ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  NEW // 3. ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà (+250)
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum PaymentMethod {
  TRANSFER
  COD
}

model Order {
  id    Int    @id @default(autoincrement())
  jobId String @unique // JOB-6701-001

  dailySeq   Int // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô (‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô)
  isUrgent   Boolean   @default(false) // ‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô (3 ‡∏ß‡∏±‡∏ô)
  blockType  BlockType @default(OLD)
  customerFb String? // ‡∏ä‡∏∑‡πà‡∏≠ Facebook ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤

  salesChannelId  Int?
  salesChannel    SalesChannel? @relation(fields: [salesChannelId], references: [id])
  embroideryCount Int           @default(0) // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏õ‡∏±‡∏Å
  customerName    String
  customerPhone   String?
  customerAddress String?
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏Å‡πÅ‡∏ö‡∏ö JSON (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤)
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: 
  // [
  //   { "position": "‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢", "width": 5, "height": 2, "type": "‡∏õ‡∏±‡∏Å", "note": "‡∏î‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡πÅ‡∏î‡∏á" },
  //   { "position": "‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á", "type": "‡∏™‡∏Å‡∏£‡∏µ‡∏ô", "isSafety": true } 
  // ]
  embroideryDetails Json?

  // --- 3. Pre-order & Purchasing Info ---
  expectedDate DateTime? // (Old field, keeping for compat if needed, but using purchasingEta)
  purchasingEta    DateTime? // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏∞‡∏ö‡∏∏)
  purchasingReason String?   // ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤

  // --- 4. Cost & Payment Info ---
  blockPrice Decimal @default(0) @db.Decimal(10, 2)
  unitPrice  Decimal @default(0) @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)
  deposit    Decimal @default(0) @db.Decimal(10, 2) // ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (Old field)
  
  paidAmount  Decimal @default(0) @db.Decimal(10, 2) // ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
  balanceDue  Decimal @default(0) @db.Decimal(10, 2) // ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞
  paymentStatus PaymentStatus @default(UNPAID)
  paymentMethod PaymentMethod @default(TRANSFER)
  depositSlipUrl String?    // URL ‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å S3
  draftImages    String[]   // ‡∏£‡∏π‡∏õ‡∏à‡∏≥‡∏•‡∏≠‡∏á/‡∏£‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏ä‡∏ó (Mockups)

  status     OrderStatus @default(PENDING_ARTWORK)
  dueDate    DateTime?

  // ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
  salesId Int
  sales   User @relation("SalesOrders", fields: [salesId], references: [id])

  graphicId Int?
  graphic   User? @relation("GraphicOrders", fields: [graphicId], references: [id])

  qcId Int?
  qc   User? @relation("QCOrders", fields: [qcId], references: [id])

  stockId Int?
  stock   User? @relation("StockOrders", fields: [stockId], references: [id])

  productionId Int?
  production   User? @relation("ProductionOrders", fields: [productionId], references: [id])

  items OrderItem[]
  logs  ActivityLog[]

  artworkUrl String? // ‡∏£‡∏π‡∏õ Artwork ‡∏à‡∏≤‡∏Å Graphic
  productionFileUrl String? // ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï (‡∏õ‡∏±‡∏Å/‡∏™‡∏Å‡∏£‡∏µ‡∏ô)
  productionFileName String? // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏¥‡∏ï
  trackingNo String? // ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏
  notes      String? // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
  cancelReason String? // ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  stockIssueReason String? // ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
  urgentNote   String? // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseRequests PurchaseRequest[]

  blockId    Int?
  block      EmbroideryBlock? @relation(fields: [blockId], references: [id])
  
  paymentSlips PaymentSlip[] // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
}

// Payment Slip - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á
model PaymentSlip {
  id        Int      @id @default(autoincrement())
  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id])
  
  amount    Decimal  @db.Decimal(10, 2) // ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ
  slipUrl   String   // URL ‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏≤‡∏Å S3
  note      String?  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô "‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 2")
  
  uploadedBy Int     // ‡∏ú‡∏π‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏°‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô Sales)
  uploader   User    @relation(fields: [uploadedBy], references: [id])
  
  createdAt DateTime @default(now())
}

model EmbroideryBlock {
  id          Int      @id @default(autoincrement())
  name        String   // Common name for the block
  code        String?  @unique // Optional unique code
  description String?
  artworkUrl  String?  // Final mockup
  productionFileUrl String? // DST/PES file
  productionFileName String?
  
  orders      Order[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OrderItem {
  id      Int   @id @default(autoincrement())
  orderId Int
  order   Order @relation(fields: [orderId], references: [id])

  // ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  productName String // Snapshot ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠
  price       Decimal @db.Decimal(10, 2)
  quantity    Int
  details     Json? // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏Å‡∏£‡∏µ‡∏ô/‡∏õ‡∏±‡∏Å
}

// --------------------------------------------------------
// üìä ‡∏™‡πà‡∏ß‡∏ô Log ‡πÅ‡∏•‡∏∞ Notification
// --------------------------------------------------------

model ActivityLog {
  id        Int      @id @default(autoincrement())
  action    String
  details   String?
  orderId   Int?
  order     Order?   @relation(fields: [orderId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  timestamp DateTime @default(now())
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  endpoint  String
  keys      Json
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model PurchaseRequest {
  id        Int                   @id @default(autoincrement())
  orderId   Int
  order     Order                 @relation(fields: [orderId], references: [id])
  variantId Int
  variant   ProductVariant        @relation(fields: [variantId], references: [id])
  quantity  Int
  status    PurchaseRequestStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PurchaseRequestStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model SalesChannel {
  id     Int     @id @default(autoincrement())
  code   String  @unique // ‡πÄ‡∏ä‡πà‡∏ô "001", "P99"
  name   String // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏à Facebook
  url    String? // Link page
  orders Order[]
}
